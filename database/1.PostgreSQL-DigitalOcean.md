# PostgreSQL Database, Users, Permissions & Backup Guide

üìö Tham kh·∫£o  

---

## 1. Create Database & Security

### T·∫°o Database v√† B·∫£o m·∫≠t
**Ch·∫°y b·∫±ng user:** `doadmin`

### T·∫°o database
```sql
CREATE DATABASE my_database;
```

### Revoke quy·ªÅn t·ª´ PUBLIC (B·∫£o m·∫≠t)
```sql
REVOKE CONNECT ON DATABASE my_database FROM PUBLIC;
REVOKE CONNECT ON DATABASE defaultdb FROM PUBLIC;
REVOKE CONNECT ON DATABASE _dodb FROM PUBLIC;

\c my_database

REVOKE ALL ON SCHEMA public FROM PUBLIC;
```

### Ki·ªÉm tra
```sql
SELECT 
    datname,
    datacl
FROM pg_database
WHERE datname = 'my_database';
```

### L∆∞u √Ω
- ‚ö†Ô∏è B·∫ÆT BU·ªòC revoke quy·ªÅn t·ª´ PUBLIC
- ‚úÖ Ch·ªâ user ƒë∆∞·ª£c c·∫•p quy·ªÅn m·ªõi v√†o ƒë∆∞·ª£c database
- üîÑ L·∫∑p l·∫°i cho t·ª´ng database n·∫øu c√≥ nhi·ªÅu database

### Rollback (kh√¥ng khuy·∫øn ngh·ªã)
```sql
GRANT CONNECT ON DATABASE my_database TO PUBLIC;
```

---

## 2. Create Full User (Production App)

User c√≥ ƒë·∫ßy ƒë·ªß quy·ªÅn:  
SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER  

**Ch·∫°y b·∫±ng user:** `doadmin`

```sql
CREATE USER my_full_user WITH PASSWORD 'StrongPassword123!';
ALTER USER my_full_user CONNECTION LIMIT 20;

GRANT CONNECT ON DATABASE my_database TO my_full_user;

\c my_database

GRANT USAGE ON SCHEMA public TO my_full_user;
GRANT CREATE ON SCHEMA public TO my_full_user;

GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO my_full_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO my_full_user;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO my_full_user;
GRANT ALL PRIVILEGES ON ALL ROUTINES IN SCHEMA public TO my_full_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON TABLES TO my_full_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON SEQUENCES TO my_full_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON FUNCTIONS TO my_full_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT ALL ON ROUTINES TO my_full_user;

ALTER DEFAULT PRIVILEGES FOR ROLE doadmin IN SCHEMA public
    GRANT ALL ON TABLES TO my_full_user;
ALTER DEFAULT PRIVILEGES FOR ROLE doadmin IN SCHEMA public
    GRANT ALL ON SEQUENCES TO my_full_user;
ALTER DEFAULT PRIVILEGES FOR ROLE doadmin IN SCHEMA public
    GRANT ALL ON FUNCTIONS TO my_full_user;
ALTER DEFAULT PRIVILEGES FOR ROLE doadmin IN SCHEMA public
    GRANT ALL ON ROUTINES TO my_full_user;
```

### Ki·ªÉm tra quy·ªÅn
```sql
SELECT 
    datname,
    has_database_privilege('my_full_user', datname, 'CONNECT') AS can_connect
FROM pg_database
WHERE datname = 'my_database';

SELECT 
    has_schema_privilege('my_full_user', 'public', 'USAGE') AS can_use,
    has_schema_privilege('my_full_user', 'public', 'CREATE') AS can_create;
```

### Test Migration
```sql
\c my_database my_full_user

CREATE TABLE test_table (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100)
);

INSERT INTO test_table (name) VALUES ('Test');
UPDATE test_table SET name = 'Updated' WHERE id = 1;
DELETE FROM test_table WHERE id = 1;
ALTER TABLE test_table ADD COLUMN email VARCHAR(255);
DROP TABLE test_table;
```

### L∆∞u √Ω
- ‚úÖ User c√≥ FULL quy·ªÅn g·∫ßn nh∆∞ owner
- ‚ö†Ô∏è B·∫ÆT BU·ªòC set DEFAULT PRIVILEGES cho doadmin
- üîê Password n√™n m·∫°nh (‚â• 16 k√Ω t·ª±)
- üìä Connection limit 20 ƒë·ªß cho production

---

## 3. Create Limit Permission User

**Ch·∫°y b·∫±ng user:** `doadmin`

### Option 1: Read-Only ALL Tables
```sql
CREATE USER my_readonly_user WITH PASSWORD 'ReadOnlyPass456!';
ALTER USER my_readonly_user CONNECTION LIMIT 10;

GRANT CONNECT ON DATABASE my_database TO my_readonly_user;
\c my_database

GRANT USAGE ON SCHEMA public TO my_readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO my_readonly_user;
GRANT USAGE ON ALL SEQUENCES IN SCHEMA public TO my_readonly_user;
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public TO my_readonly_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
    GRANT SELECT ON TABLES TO my_readonly_user;

-- Thay doadmin b·∫±ng user t·∫°o table
ALTER DEFAULT PRIVILEGES FOR ROLE doadmin IN SCHEMA public
    GRANT SELECT ON TABLES TO my_readonly_user;
```

### Option 2: Limit permission Specific Tables
```sql
CREATE USER my_limited_user WITH PASSWORD 'LimitedPass789!';
ALTER USER my_limited_user CONNECTION LIMIT 5;

GRANT CONNECT ON DATABASE my_database TO my_limited_user;
\c my_database

GRANT USAGE ON SCHEMA public TO my_limited_user;

-- C·∫•p ALL PRIVILEGES tr√™n b·∫£ng
GRANT ALL PRIVILEGES ON attendance_logs TO my_limited_user;
-- GRANT ALL PRIVILEGES => SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER
-- C·∫•p ALL PRIVILEGES tr√™n sequence (ƒë·ªÉ INSERT v·ªõi id t·ª± tƒÉng)
SELECT pg_get_serial_sequence('public.attendance_logs', 'id'); -- K·∫øt qu·∫£: public.attendance_logs_id_seq
GRANT ALL PRIVILEGES ON SEQUENCE public.attendance_logs_id_seq TO my_limited_user;
```

### Ki·ªÉm tra quy·ªÅn
```sql
SELECT 
    schemaname || '.' || tablename AS table_name,
    has_table_privilege(
        'my_readonly_user',
        schemaname || '.' || tablename,
        'SELECT'
    ) AS can_select
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY tablename;
```

---

## 4. Backup & Restore

```bash
# Dump
PGPASSWORD="<password>" pg_dump \
  -h <db_host> \
  -p <db_port> \
  -U <db_user> \
  -d <db_database> \
  -t <db_table> \
  -F p \
  --no-owner \
  --no-privileges \
  -f ./data_bak_01_01_2025.sql

# Restore
PGPASSWORD="<password>" PGSSLMODE=require psql \
  -h <db_host> \
  -p <db_port> \
  -U <db_user> \
  -d <db_database> \
  -f ./data_bak_01_01_2025.sql
```

### Gi·∫£i th√≠ch
- `-F p`: dump SQL thu·∫ßn
- `--no-owner`: kh√¥ng set owner
- `--no-privileges`: kh√¥ng export GRANT/REVOKE
- Tr√°nh l·ªói permission khi restore

### Fix l·ªói permission khi restore
```sql
GRANT CREATE, USAGE ON SCHEMA public TO <db_user>;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO <db_user>;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO <db_user>;
```

---

## 5. Fix Bug: Permission denied for schema public

```sql
GRANT USAGE ON SCHEMA public TO "<user_name>";
GRANT CREATE ON SCHEMA public TO "<user_name>";
```
