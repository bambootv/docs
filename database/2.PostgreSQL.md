[Docs](https://www.postgresql.org/docs/13/app-pg-dumpall.html)

1. Backup and Restore

```bash
# Dump
PGPASSWORD="<password>" pg_dump \
    -h <db_host> \
    -p <db_port> \
    -U <db_user> \
    -d <db_database> \
    -t <db_table> \
    -F p \
    --no-owner \
    --no-privileges \
    -f ./data_bak_01_01_2025.sql

# Restore
PGPASSWORD="<password>" PGSSLMODE=require psql \
    -h <db_host> \
    -p <db_port> \
    -U <db_user> \
    -d <db_database> \
    -f ./data_bak_01_01_2025.sql

# -F p: -F = format, p = plain text SQL. N√™n -F p = xu·∫•t file dump d∆∞·ªõi d·∫°ng SQL thu·∫ßn, c√≥ th·ªÉ m·ªü b·∫±ng editor v√† ch·∫°y b·∫±ng psql.
# --no-owner: Kh√¥ng ƒë·∫∑t OWNER cho table, sequence, view, function... khi dump, gi√∫p restore an to√†n h∆°n ·ªü m√¥i tr∆∞·ªùng kh√°c.
# --no-privileges: kh√¥ng export GRANT/REVOKE, gi√∫p file dump ‚Äús·∫°ch‚Äù h∆°n v√† tr√°nh l·ªói permission khi restore. (--clean: Drop table, -s: Schema only)

# ERROR:  permission denied for schema public
# Login as supper user
GRANT CREATE, USAGE ON SCHEMA public TO <db_user>;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO <db_user>;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO <db_user>;

```

2. Digital Ocean

```bash
# Permission denined for public schema
# Let login as doamin then
GRANT USAGE ON SCHEMA public TO "<user_name>";
GRANT CREATE ON SCHEMA public TO "<user_name>";
```

```bash
# Connection pooling
process.env.POSTGRES_DB # This is connection pooling name
```

```bash
# Create read only user
CREATE USER user_xxx WITH PASSWORD 'password_xxx';
GRANT CONNECT ON DATABASE database_xxx TO user_xxx;

GRANT USAGE ON SCHEMA public TO user_xxx;
GRANT SELECT ON TABLE table_123 TO user_xxx;
GRANT SELECT, INSERT, UPDATE, DELETE ON table_456 TO user_xxx;

GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO user_xxx;

REVOKE CREATE ON SCHEMA public FROM user_xxx;
```

```bash
# Create read only user
‚úÖ 1. T·∫°o user read-only
CREATE USER readonly_user WITH PASSWORD 'your_password';

‚úÖ 2. C·∫•p quy·ªÅn CONNECT v√†o database
GRANT CONNECT ON DATABASE your_database TO readonly_user;

‚úÖ 3. C·∫•p quy·ªÅn USAGE tr√™n schema

(PostgreSQL m·∫∑c ƒë·ªãnh d√πng schema public)

GRANT USAGE ON SCHEMA public TO readonly_user;

‚úÖ 4. C·∫•p quy·ªÅn SELECT tr√™n t·∫•t c·∫£ b·∫£ng hi·ªán c√≥
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

‚úÖ 5. C·∫•p quy·ªÅn SELECT cho t·∫•t c·∫£ b·∫£ng t·∫°o trong t∆∞∆°ng lai

ƒê√¢y l√† ph·∫ßn quan tr·ªçng nh·∫•t.

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT SELECT ON TABLES TO readonly_user;

üîê 6. C·∫•p quy·ªÅn ƒë·ªçc SEQUENCES (n·∫øu b·∫£ng c√≥ SERIAL / IDENTITY)

M·ªôt s·ªë ORM ho·∫∑c query ƒë·ªçc ID c·∫ßn quy·ªÅn ƒë·ªçc sequence.

GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO readonly_user;

ALTER DEFAULT PRIVILEGES IN SCHEMA public
GRANT USAGE, SELECT ON SEQUENCES TO readonly_user;

üö´ 7. (Tu·ª≥ ch·ªçn) NgƒÉn user t·∫°o b·∫£ng, insert, update, delete
REVOKE CREATE ON SCHEMA public FROM readonly_user;
REVOKE INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public FROM readonly_user;
```

2. Update multi row

```SQL
update public.users as row set
    first_name = data.first_name,
    last_name = data.last_name,
    detail = data.detail
from (values
    (1, 'A', 'B', '{"locales":"HN"}'::jsonb),
    (2, 'C', 'D', '{"locales":"HN"}'::jsonb),
    (3, 'E', 'F', '{"locales":"HN"}'::jsonb)
) as data(id, first_name, last_name, detail)
where data.id = row.id
```

```javascript
let updateData = "";
payload.forEach((el) => {
  el.detail = el.detail.replace(/'/g, "");
  updateData += `('${el.id}','${JSON.stringify(el.detail)}'::jsonb),`;
});
if (updateData.length > 0) {
  return knex.raw(`
        update public.ad_accounts as row set
        detail = data.detail
        from (values ${updateData.slice(0, -1)})
        as data(id, detail)
        where data.id = row.id
    `);
}
```

```javascript
let updateData = "";
payload.forEach((el) => {
  updateData += `('${el.id}','${JSON.stringify(el.detail)}'::jsonb),`;
});
if (updateData.length > 0) {
  return knex.raw(
    `
        update public.ad_accounts as row set
        detail = data.detail
        from (values ?)
        as data(id, detail)
        where data.id = row.id
    `,
    updateData.slice(0, -1)
  );
}
```

```javascript
let raw = "";
data.forEach((el) => {
  raw += `(
        '${el.last_sync_at || null}',
        '${el.facebook_name || null}',
        ${el.facebook_ad_id},
        '${el.facebook_status || null}',
        '${JSON.stringify(el.facebook_creative)}',
        ${el.facebook_bid_amount || null},
        ${el.facebook_tracking_specs || null}
    ),`;
});
if (raw.length === 0) {
  return true;
}

return knex.raw(`
    UPDATE
        ads t
    SET
        last_sync_at = data.last_sync_at::timestamp,
        facebook_name = data.facebook_name,
        facebook_status = data.facebook_status,
        facebook_creative = data.facebook_creative::jsonb,
        facebook_bid_amount = data.facebook_bid_amount::bigint,
        facebook_tracking_specs = data.facebook_tracking_specs::jsonb[]
    FROM
        (
            values ${raw.slice(0, -1)}
        )
        data (
            last_sync_at,
            facebook_name,
            facebook_ad_id,
            facebook_status,
            facebook_creative,
            facebook_bid_amount,
            facebook_tracking_specs
        )
    WHERE
        t.facebook_ad_id = data.facebook_ad_id
`);
```

3. Search without accent
   Note: Need permission

```SQL
CREATE EXTENSION IF NOT EXISTS unaccent;

SELECT *
FROM "campaigns"
WHERE  unaccent(facebook_name) ILIKE unaccent('Chien d·ªãch moi');
```

4. Truncate table

```
truncate ad_accounts RESTART IDENTITY CASCADE
```

5. Update validate enum

```
exports.up = (knex) => {
    return knex.schema.raw(`
        ALTER TABLE "coupons"
        DROP CONSTRAINT "coupons_type_check",
        ADD CONSTRAINT "coupons_type_check"
        CHECK (type IN ('percentage', 'flat'))
    `);
};
```

6. Joins

```
publishable(userId) {
        return this.leftJoin('drafts', function condition() {
            this.on('drafts.object_id', '=', 'campaigns.id');
        })
            .where(function findbyCamStatus() {
                this.whereNotIn('campaigns.sync_status', ['need_publish', 'publishing']) // change way to see with notIn
                    .orWhere(function findbyDraftStatus() {
                        this.where('campaigns.sync_status', '=', 'active')
                            .where('drafts.object_type', '=', 'campaign')
                            .where('drafts.user_id', '=', userId)
                            .whereNotIn('drafts.sync_status', ['need_publish', 'publishing', 'need_update', 'updating']);
                    });
            });
    }
```

where ·ªü ngo√†i th√¨ leftjoin b

```
.leftJoin('drafts', 'drafts.object_id', '=', 'campaigns.id')
                .where('drafts.object_type', '=', 'campaign')
                .where('drafts.user_id', '=', ctx.meta.user.id);
            // .leftJoin('request_details', function complexJoin() {
            //     this.on(
            //         'request_details.object_id', '=', 'campaigns.id'
            //     ).andOn(
            //         'request_details.object_type', '=', this.knex().raw('?', ['campaign'])
            //     ).andOn(
            //         'request_details.status', '=', this.knex().raw('?', ['waiting'])
            //     );
            // });
```

7. Where `unaccent`

```
query.where(function name() {
                        this.where(knex.raw('unaccent(facebook_name)'), 'ilike', knex.raw(`unaccent('%${ctx.params.keyword}%')`))
                            .orWhere(knex.raw('facebook_campaign_id::TEXT'), 'ilike', `%${ctx.params.keyword}%`);
                    });
```


8. CASE WHEN

```
.select(['ads.*'].concat([
    'drafts.content as draft',
    knex.raw('CASE WHEN request_details.id > 0 THEN true ELSE false END AS in_request')
]));
```
